<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TCG Card Organizer (Shared)</title>
<style>
  :root{--bg:#0f1724;--card:#071028;--muted:#9aa7b8;--accent:#38bdf8;--panel:#0b1220;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#e6eef6}
  body{margin:0;background:linear-gradient(180deg,#071021 0%, #061427 100%);min-height:100vh;padding:24px}
  .app{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:360px 1fr;gap:20px}
  .panel{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
  h1{margin:0 0 12px 0;font-size:20px;color:var(--accent)}
  label{display:block;font-size:13px;color:var(--muted);margin-top:12px}
  input[type="text"],input[type="number"],select,textarea{width:100%;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--panel);color:inherit;font-size:14px;box-sizing:border-box}
  textarea{min-height:90px;resize:vertical}
  .row{display:flex;gap:8px}
  .row>*{flex:1}
  .btn{display:inline-block;padding:8px 12px;border-radius:8px;background:var(--accent);color:#022;cursor:pointer;border:0;font-weight:600}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:500}
  .controls{display:flex;gap:8px;align-items:center;margin-top:12px}
  .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);cursor:pointer;border:1px solid rgba(255,255,255,0.03);font-size:13px;color:var(--muted)}
  .chip.active{background:linear-gradient(90deg, rgba(56,189,248,0.12), rgba(56,189,248,0.04));border-color:rgba(56,189,248,0.18);color:var(--accent)}
  .list{padding:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .cardItem{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .cardHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .cardTitle{font-weight:700;margin:0;font-size:15px}
  .meta{font-size:12px;color:var(--muted)}
  .tag{display:inline-block;background:rgba(255,255,255,0.03);padding:4px 8px;border-radius:999px;margin-right:6px;font-size:12px;color:var(--muted)}
  .cardButtons{display:flex;gap:6px;margin-top:10px}
  .small{padding:6px 8px;font-size:13px;border-radius:8px;border:0;cursor:pointer}
  .edit{background:#ffd166;color:#1b1b1b}
  .delete{background:#ef476f;color:#fff}
  footer{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}
  .colorDot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:middle;border:1px solid rgba(255,255,255,0.06)}
  .colorRed{background:#ef4444}.colorBlue{background:#3b82f6}.colorGreen{background:#10b981}
  .colorPink{background:#ec4899}.colorBlack{background:#111827}.colorWhite{background:#f3f4f6;border:1px solid #d1d5db}
  .typeBadge{display:inline-block;padding:4px 8px;border-radius:8px;background:rgba(255,255,255,0.03);color:var(--muted);font-size:12px;margin-left:6px}
  .helper{font-size:12px;color:var(--muted);margin-top:6px}
  .hidden{display:none}
  .status{font-size:12px;color:var(--muted);margin-bottom:8px}
  .empty{color:var(--muted);padding:20px;text-align:center}
  @media(max-width:880px){.app{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">
  <div class="panel" id="editorPanel" aria-label="Card editor">
    <h1>Card Editor</h1>
    <div class="status" id="status">Connecting to server...</div>
    <input type="hidden" id="editingId" value="">
    <label>Name</label><input id="name" type="text" placeholder="Card name" />
    <label>Text</label><textarea id="text" placeholder="Card rules, lore, etc."></textarea>
    <label>Tags</label><input id="tags" type="text" placeholder="Comma separated tags e.g. token, removal" />

    <label>Card Type</label>
    <select id="cardType">
      <option value="Unit">Unit</option>
      <option value="Hero">Hero</option>
      <option value="Weapon">Weapon</option>
      <option value="Spell">Spell</option>
    </select>

    <div id="costRow">
      <label>Cost</label><input id="cost" type="number" min="0" />
    </div>

    <div id="diceRow" class="hidden">
      <label>Dice</label><input id="dice" type="text" placeholder="e.g. 1d6, 2" />
      <div class="helper">Enter dice value or number used for Hero resolution</div>
    </div>

    <div id="flipConditionRow" class="hidden">
      <label>Flip condition</label><input id="flipCondition" type="text" placeholder="Condition to flip" />
    </div>

    <div id="flipTextRow" class="hidden">
      <label>Flip text</label><textarea id="flipText" placeholder="Text that appears after flip"></textarea>
    </div>

    <div id="statsRow">
      <div class="row">
        <div><label>Power</label><input id="power" type="number" min="0" /></div>
        <div><label>Health</label><input id="health" type="number" min="0" /></div>
      </div>
    </div>

    <div id="spellSpeedRow" class="hidden">
      <label>Spell speed</label>
      <select id="spellSpeed"><option value="Slow">Slow</option><option value="Fast">Fast</option></select>
      <div class="helper">Choose Slow or Fast for spells</div>
    </div>

    <label>Color</label>
    <select id="color">
      <option value="Colorless">Colorless</option>
      <option value="Red">Red</option>
      <option value="Blue">Blue</option>
      <option value="Green">Green</option>
      <option value="Pink">Pink</option>
      <option value="White">White</option>
      <option value="Black">Black</option>
    </select>

    <div class="controls">
      <button class="btn" id="saveBtn">Save Card</button>
      <button class="btn secondary" id="clearBtn">Clear Form</button>
      <button class="btn secondary" id="exportBtn">Export JSON</button>
      <button class="btn secondary" id="refreshBtn">Refresh</button>
    </div>

    <footer>Saved centrally when server available; fallback to localStorage when offline.</footer>
  </div>

  <div class="panel" id="libraryPanel" aria-label="Card library">
    <h1>Library</h1>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <input id="search" type="text" placeholder="Search by name, tag, or type" style="flex:1;padding:8px;border-radius:8px;background:var(--panel);border:1px solid rgba(255,255,255,0.03);color:inherit" />
      <select id="sort" style="padding:8px;border-radius:8px;background:var(--panel);border:1px solid rgba(255,255,255,0.03);color:inherit">
        <option value="newest">Newest</option><option value="name">Name A→Z</option><option value="cost">Cost low→high</option>
      </select>
    </div>

    <div class="filters" id="colorFilters">
      <div class="chip active" data-color="All">All</div>
      <div class="chip" data-color="Red"><span class="colorDot colorRed"></span>Red</div>
      <div class="chip" data-color="Blue"><span class="colorDot colorBlue"></span>Blue</div>
      <div class="chip" data-color="Green"><span class="colorDot colorGreen"></span>Green</div>
      <div class="chip" data-color="Pink"><span class="colorDot colorPink"></span>Pink</div>
      <div class="chip" data-color="White"><span class="colorDot colorWhite"></span>White</div>
      <div class="chip" data-color="Black"><span class="colorDot colorBlack"></span>Black</div>
      <div class="chip" data-color="Colorless">Colorless</div>
    </div>

    <div id="listArea">
      <div class="list" id="cardList"></div>
      <div id="empty" class="empty" style="display:none">No cards yet. Create one using the editor on the left.</div>
    </div>
  </div>
</div>

<div id="confirm" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(2,6,23,0.6)">
  <div style="background:#071028;padding:16px;border-radius:10px;max-width:400px;width:90%">
    <div style="margin-bottom:12px;color:var(--muted)">Delete this card permanently?</div>
    <div style="text-align:right">
      <button id="cancelDelete" class="btn secondary" style="margin-right:8px">Cancel</button>
      <button id="confirmDelete" class="btn" style="background:#ef476f">Delete</button>
    </div>
  </div>
</div>

<script>
(function(){
  const API_BASE = '/api'; // if hosting client separately set full URL e.g. "https://yourdomain.com/api"
  const LS_KEY = 'tcg_cards_shared_v1';

  const formEls = {
    id: document.getElementById('editingId'),
    name: document.getElementById('name'),
    text: document.getElementById('text'),
    tags: document.getElementById('tags'),
    cost: document.getElementById('cost'),
    power: document.getElementById('power'),
    health: document.getElementById('health'),
    color: document.getElementById('color'),
    type: document.getElementById('cardType'),
    dice: document.getElementById('dice'),
    flipCondition: document.getElementById('flipCondition'),
    flipText: document.getElementById('flipText'),
    spellSpeed: document.getElementById('spellSpeed')
  };

  const rows = {
    costRow: document.getElementById('costRow'),
    statsRow: document.getElementById('statsRow'),
    diceRow: document.getElementById('diceRow'),
    flipConditionRow: document.getElementById('flipConditionRow'),
    flipTextRow: document.getElementById('flipTextRow'),
    spellSpeedRow: document.getElementById('spellSpeedRow')
  };

  const statusEl = document.getElementById('status');
  const saveBtn = document.getElementById('saveBtn');
  const clearBtn = document.getElementById('clearBtn');
  const exportBtn = document.getElementById('exportBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const cardList = document.getElementById('cardList');
  const empty = document.getElementById('empty');
  const searchInput = document.getElementById('search');
  const sortSelect = document.getElementById('sort');
  const colorFilters = document.getElementById('colorFilters');
  const confirmEl = document.getElementById('confirm');
  const cancelDelete = document.getElementById('cancelDelete');
  const confirmDelete = document.getElementById('confirmDelete');

  let cards = [];
  let activeColor = 'All';
  let toDeleteId = null;
  let serverAvailable = false;

  // small helpers
  function uid(){ return 'c_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,8); }
  function escapeHtml(s){ if(!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function showStatus(txt){ statusEl.textContent = txt; }

  // Server communication
  async function testServer(){
    try{
      const res = await fetch(API_BASE + '/cards', { method: 'HEAD' });
      serverAvailable = res && res.ok;
    }catch(e){
      serverAvailable = false;
    }
    showStatus(serverAvailable ? 'Connected to server' : 'Offline / using local storage');
    return serverAvailable;
  }

  async function fetchCardsFromServer(){
    try{
      const res = await fetch(API_BASE + '/cards');
      if(!res.ok) throw new Error('Bad response');
      const arr = await res.json();
      cards = arr;
      localStorage.setItem(LS_KEY, JSON.stringify({ ts: Date.now(), cards: arr }));
      renderList();
      return true;
    }catch(e){
      // fallback to local cache
      const cached = localStorage.getItem(LS_KEY);
      if(cached){
        try{ cards = JSON.parse(cached).cards || []; }catch(e){}
      } else {
        cards = [];
      }
      renderList();
      return false;
    }
  }

  async function createCardOnServer(card){
    try{
      const res = await fetch(API_BASE + '/cards', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(card)
      });
      if(!res.ok) throw new Error('Create failed');
      return await res.json();
    }catch(e){
      return null;
    }
  }
  async function updateCardOnServer(id, card){
    try{
      const res = await fetch(API_BASE + '/cards/' + encodeURIComponent(id), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(card)
      });
      if(!res.ok) throw new Error('Update failed');
      return await res.json();
    }catch(e){
      return null;
    }
  }
  async function deleteCardOnServer(id){
    try{
      const res = await fetch(API_BASE + '/cards/' + encodeURIComponent(id), { method: 'DELETE' });
      return res && (res.status === 204 || res.ok);
    }catch(e){
      return false;
    }
  }

  // Fallback local CRUD
  function loadLocal(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return [];
      const parsed = JSON.parse(raw);
      return parsed.cards || [];
    }catch(e){ return []; }
  }
  function saveLocalAll(arr){
    localStorage.setItem(LS_KEY, JSON.stringify({ ts: Date.now(), cards: arr }));
  }

  // UI logic
  function updateVisibleFields(){
    const t = formEls.type.value;
    if(t === 'Spell'){
      rows.costRow.classList.remove('hidden');
      rows.statsRow.classList.add('hidden');
      rows.diceRow.classList.add('hidden');
      rows.flipConditionRow.classList.add('hidden');
      rows.flipTextRow.classList.add('hidden');
      rows.spellSpeedRow.classList.remove('hidden');
    } else if(t === 'Hero'){
      rows.costRow.classList.add('hidden');
      rows.statsRow.classList.remove('hidden');
      rows.diceRow.classList.remove('hidden');
      rows.flipConditionRow.classList.remove('hidden');
      rows.flipTextRow.classList.remove('hidden');
      rows.spellSpeedRow.classList.add('hidden');
    } else {
      rows.costRow.classList.remove('hidden');
      rows.statsRow.classList.remove('hidden');
      rows.diceRow.classList.add('hidden');
      rows.flipConditionRow.classList.add('hidden');
      rows.flipTextRow.classList.add('hidden');
      rows.spellSpeedRow.classList.add('hidden');
    }
  }

  function clearForm(){
    formEls.id.value = '';
    formEls.name.value = '';
    formEls.text.value = '';
    formEls.tags.value = '';
    formEls.cost.value = '';
    formEls.power.value = '';
    formEls.health.value = '';
    formEls.color.value = 'Colorless';
    formEls.type.value = 'Unit';
    formEls.dice.value = '';
    formEls.flipCondition.value = '';
    formEls.flipText.value = '';
    formEls.spellSpeed.value = 'Slow';
    saveBtn.textContent = 'Save Card';
    updateVisibleFields();
    window.scrollTo({top:0,behavior:'smooth'});
  }

  function fillForm(card){
    formEls.id.value = card.id;
    formEls.name.value = card.name || '';
    formEls.text.value = card.text || '';
    formEls.tags.value = (card.tags||[]).join(', ');
    formEls.cost.value = card.cost == null ? '' : card.cost;
    formEls.power.value = card.power == null ? '' : card.power;
    formEls.health.value = card.health == null ? '' : card.health;
    formEls.color.value = card.color || 'Colorless';
    formEls.type.value = card.type || 'Unit';
    formEls.dice.value = card.dice || '';
    formEls.flipCondition.value = card.flipCondition || '';
    formEls.flipText.value = card.flipText || '';
    formEls.spellSpeed.value = card.spellSpeed || 'Slow';
    saveBtn.textContent = 'Update Card';
    updateVisibleFields();
    window.scrollTo({top:0,behavior:'smooth'});
  }

  async function addOrUpdate(){
    const data = {
      id: formEls.id.value || uid(),
      name: formEls.name.value.trim(),
      text: formEls.text.value.trim(),
      tags: formEls.tags.value.split(',').map(t=>t.trim()).filter(t=>t),
      cost: formEls.cost.value === '' ? null : Number(formEls.cost.value),
      power: formEls.power.value === '' ? null : Number(formEls.power.value),
      health: formEls.health.value === '' ? null : Number(formEls.health.value),
      color: formEls.color.value || 'Colorless',
      type: formEls.type.value || 'Unit',
      dice: formEls.dice.value || null,
      flipCondition: formEls.flipCondition.value || null,
      flipText: formEls.flipText.value || null,
      spellSpeed: formEls.spellSpeed.value || null,
      updated: Date.now()
    };
    if(!data.name){ alert('Please give the card a name.'); return; }

    // normalize
    if(data.type === 'Spell'){
      data.power = null;
      data.health = null;
    } else if(data.type === 'Hero'){
      data.cost = null;
    }

    // try server first
    if(serverAvailable){
      const existing = cards.find(c=>c.id === data.id);
      let resp = null;
      if(existing){
        resp = await updateCardOnServer(data.id, data);
      } else {
        resp = await createCardOnServer(data);
      }
      if(resp){
        await fetchCardsFromServer();
        clearForm();
        return;
      }
    }

    // fallback local
    const local = loadLocal();
    const idx = local.findIndex(c=>c.id === data.id);
    if(idx >= 0) local[idx] = data; else local.unshift(data);
    saveLocalAll(local);
    cards = local;
    renderList();
    clearForm();
  }

  function renderList(){
    const q = searchInput.value.trim().toLowerCase();
    let filtered = cards.filter(c=>{
      if(activeColor !== 'All' && c.color !== activeColor) return false;
      if(!q) return true;
      if(c.name && c.name.toLowerCase().includes(q)) return true;
      if((c.tags||[]).some(t=>t.toLowerCase().includes(q))) return true;
      if((c.type||'').toLowerCase().includes(q)) return true;
      return (c.text||'').toLowerCase().includes(q);
    });

    const sortBy = sortSelect.value;
    if(sortBy === 'name'){ filtered.sort((a,b)=>a.name.localeCompare(b.name)); }
    else if(sortBy === 'cost'){ filtered.sort((a,b)=> (a.cost||0) - (b.cost||0)); }
    else { filtered.sort((a,b)=> b.updated - a.updated); }

    cardList.innerHTML = '';
    if(filtered.length === 0){ empty.style.display = 'block'; return; }
    empty.style.display = 'none';

    for(const c of filtered){
      const div = document.createElement('div');
      div.className = 'cardItem';
      const header = document.createElement('div'); header.className = 'cardHeader';
      const title = document.createElement('div');
      const costText = c.type === 'Hero' ? `Dice ${escapeHtml(c.dice || '-')}` : `Cost ${c.cost == null ? '-' : c.cost}`;
      title.innerHTML = `<div class="cardTitle">${escapeHtml(c.name)}</div><div class="meta">${escapeHtml(c.color)} • ${escapeHtml(c.type || 'Unit')} • ${costText}</div>`;
      header.appendChild(title);
      div.appendChild(header);

      const body = document.createElement('div');
      body.innerHTML = `<div style="font-size:13px;color:var(--muted);margin-bottom:8px">${escapeHtml(c.text || '')}</div>`;
      div.appendChild(body);

      if(c.tags && c.tags.length){
        const tagsWrap = document.createElement('div');
        for(const t of c.tags){
          const sp = document.createElement('span'); sp.className = 'tag'; sp.textContent = t; tagsWrap.appendChild(sp);
        }
        div.appendChild(tagsWrap);
      }

      const meta = document.createElement('div'); meta.style.marginTop = '8px';
      let statsHtml = '';
      if(c.type !== 'Spell'){ statsHtml = `P ${c.power == null ? '-' : c.power} • H ${c.health == null ? '-' : c.health}`; }
      else { statsHtml = `Speed ${escapeHtml(c.spellSpeed || '-')}`; }
      let flipHtml = '';
      if(c.type === 'Hero'){ flipHtml = ` <span class="typeBadge">Flip: ${escapeHtml(c.flipCondition || '-')}</span>`; }
      meta.innerHTML = `<div class="meta">${statsHtml}<span class="typeBadge">${escapeHtml(c.type || 'Unit')}</span>${flipHtml}</div>`;
      div.appendChild(meta);

      const btns = document.createElement('div'); btns.className = 'cardButtons';
      const edit = document.createElement('button'); edit.className = 'small edit'; edit.textContent = 'Edit'; edit.onclick = ()=> fillForm(c);
      const del = document.createElement('button'); del.className = 'small delete'; del.textContent = 'Delete'; del.onclick = ()=> confirmDeleteCard(c.id);
      btns.appendChild(edit); btns.appendChild(del); div.appendChild(btns);
      cardList.appendChild(div);
    }
  }

  function confirmDeleteCard(id){ toDeleteId = id; confirmEl.style.display = 'flex'; }
  cancelDelete.onclick = ()=>{ toDeleteId = null; confirmEl.style.display = 'none'; };
  confirmDelete.onclick = async ()=>{
    if(!toDeleteId) return;
    // delete from server if available
    if(serverAvailable){
      const ok = await deleteCardOnServer(toDeleteId);
      if(ok) await fetchCardsFromServer();
      else {
        // fallback local deletion
        const local = loadLocal().filter(c=>c.id !== toDeleteId);
        saveLocalAll(local);
        cards = local;
        renderList();
      }
    } else {
      const local = loadLocal().filter(c=>c.id !== toDeleteId);
      saveLocalAll(local);
      cards = local;
      renderList();
    }
    toDeleteId = null;
    confirmEl.style.display = 'none';
  };

  // events
  saveBtn.addEventListener('click', addOrUpdate);
  clearBtn.addEventListener('click', clearForm);
  exportBtn.addEventListener('click', ()=>{
    const out = JSON.stringify(cards, null, 2);
    navigator.clipboard && navigator.clipboard.writeText(out).then(()=> alert('JSON copied to clipboard'), ()=>{ const w = window.open(); w.document.open(); w.document.write('<pre>'+escapeHtml(out)+'</pre>'); w.document.close(); });
  });
  refreshBtn.addEventListener('click', async ()=>{
    serverAvailable = await testServer();
    await fetchCardsFromServer();
  });

  searchInput.addEventListener('input', renderList);
  sortSelect.addEventListener('change', renderList);

  colorFilters.addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip'); if(!chip) return;
    Array.from(colorFilters.querySelectorAll('.chip')).forEach(el=>el.classList.remove('active'));
    chip.classList.add('active');
    activeColor = chip.dataset.color || 'All';
    renderList();
  });

  formEls.type.addEventListener('change', updateVisibleFields);

  window.addEventListener('keydown', function(e){ if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's'){ e.preventDefault(); addOrUpdate(); } });

  // init
  (async function init(){
    serverAvailable = await testServer();
    await fetchCardsFromServer();
    if(!serverAvailable){
      // load local immediately
      cards = loadLocal();
      renderList();
    }
  })();

  // expose simple API
  window.TCGCardApp = {
    getAll: ()=>cards.slice(),
    importJson: function(json){
      try{
        const arr = typeof json === 'string' ? JSON.parse(json) : json;
        if(!Array.isArray(arr)) throw new Error('Expected array');
        // merge locally and try pushing to server if available
        for(const it of arr){
          if(!it.id) it.id = uid();
          it.updated = Date.now();
        }
        // prefer server sync if available
        if(serverAvailable){
          // naive: push all items individually
          (async ()=>{
            for(const it of arr){
              await createCardOnServer(it);
            }
            await fetchCardsFromServer();
          })();
        } else {
          const local = loadLocal();
          const merged = arr.concat(local);
          saveLocalAll(merged);
          cards = merged;
          renderList();
        }
        return true;
      }catch(e){
        console.error(e);
        return false;
      }
    }
  };

})();
</script>
</body>
</html>